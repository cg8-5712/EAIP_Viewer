# EAIP Viewer 安装部署指南

## 目录
- [环境准备](#环境准备)
- [开发环境搭建](#开发环境搭建)
- [依赖安装详解](#依赖安装详解)
- [配置说明](#配置说明)
- [运行调试](#运行调试)
- [生产环境打包](#生产环境打包)
- [常见问题排查](#常见问题排查)

---

## 环境准备

### 系统要求

#### 硬件要求
- **CPU**: 双核及以上处理器（推荐 Intel i5 或 AMD Ryzen 5 及以上）
- **内存**: 4GB RAM 最低，8GB RAM 推荐
- **显卡**: 支持 OpenGL 2.0+ 的显卡（QML 渲染需要硬件加速）
- **磁盘空间**:
  - 开发环境: 2GB（包含 Python、依赖库、开发工具）
  - 生产环境: 1GB 基础安装 + 航图数据包（约 1-3GB）
- **显示器**: 1920x1080 分辨率推荐（最低 1366x768）

#### 操作系统支持
- **Windows**:
  - Windows 10 (1809+) / Windows 11
  - 支持 x64 架构
- **macOS**:
  - macOS 10.15 Catalina 及以上
  - 支持 Intel 和 Apple Silicon (M1/M2/M3)
- **Linux**:
  - Ubuntu 20.04 LTS / 22.04 LTS / 24.04 LTS
  - Fedora 35+
  - Debian 11+
  - Arch Linux（最新版）

### Python 环境

#### Python 版本选择
- **最低要求**: Python 3.9
- **推荐版本**: Python 3.11 (性能提升 25%，类型检查更完善)
- **兼容版本**: Python 3.9 / 3.10 / 3.11 / 3.12

#### Python 安装

##### Windows
1. 访问 [Python 官网](https://www.python.org/downloads/)
2. 下载 Python 3.11.x 安装包（64位）
3. 安装时**务必勾选** "Add Python to PATH"
4. 验证安装：
```bash
python --version
pip --version
```

##### macOS
```bash
# 使用 Homebrew 安装（推荐）
brew install python@3.11

# 或使用 pyenv 管理多版本
brew install pyenv
pyenv install 3.11.7
pyenv global 3.11.7
```

##### Linux (Ubuntu/Debian)
```bash
# Ubuntu 22.04+ 已包含 Python 3.10+
sudo apt update
sudo apt install python3.11 python3.11-venv python3-pip

# 如需 Python 3.11
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
sudo apt install python3.11 python3.11-venv
```

##### Linux (Fedora)
```bash
sudo dnf install python3.11 python3-pip
```

---

## 开发环境搭建

### 1. 克隆项目

```bash
# HTTPS 方式
git clone https://github.com/cg8-5712/EAIP_Viewer.git
cd EAIP_Viewer

# 或 SSH 方式（需配置 SSH key）
git clone git@github.com:cg8-5712/EAIP_Viewer.git
cd EAIP_Viewer
```

### 2. 创建虚拟环境

**为什么需要虚拟环境？**
- 隔离项目依赖，避免版本冲突
- 便于依赖管理和迁移
- 不污染系统 Python 环境

#### Windows
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate

# 激活后，命令提示符会显示 (venv)
```

#### macOS / Linux
```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 激活后，终端提示符会显示 (venv)
```

### 3. 升级 pip 和基础工具

```bash
# 升级 pip 到最新版本
python -m pip install --upgrade pip

# 安装基础构建工具
pip install --upgrade setuptools wheel
```

---

## 依赖安装详解

### 安装生产依赖

```bash
# 安装所有生产环境依赖
pip install -r requirements.txt

# 如果下载速度慢，使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 安装开发依赖

```bash
# 安装开发工具（测试、代码检查、打包工具等）
pip install -r requirements-dev.txt
```

### 核心依赖说明

#### 1. PyQt6 (GUI 框架)
```bash
pip install PyQt6>=6.4.0
```
- 提供 Qt6 Python 绑定
- 包含 Widgets、QML、Quick 模块
- Windows 用户可能需要安装 Visual C++ Redistributable

#### 2. PyMuPDF (PDF 渲染)
```bash
pip install PyMuPDF>=1.23.0
```
- 高性能 PDF 渲染引擎
- 支持 PDF 解析、图像提取、文本提取
- 比 PyPDF2 快 10-50 倍

#### 3. cryptography (加密库)
```bash
pip install cryptography>=41.0.0
```
- 提供 AES-256 加密
- PBKDF2 密钥派生
- 需要编译器支持（Windows 用户自动安装预编译包）

#### 4. SQLAlchemy (ORM)
```bash
pip install SQLAlchemy>=2.0.0
```
- 数据库操作抽象层
- 支持 SQLite、PostgreSQL、MySQL 等

### 平台特定依赖

#### Windows
```bash
# Windows 特有：Win32 API 封装
pip install pywin32
```

#### macOS
```bash
# macOS 特有：Cocoa API 封装
pip install pyobjc-framework-Cocoa
```

#### Linux
需要安装系统级依赖：

##### Ubuntu/Debian
```bash
sudo apt install \
  libgl1-mesa-glx \
  libxcb-xinerama0 \
  libxkbcommon-x11-0 \
  libxcb-icccm4 \
  libxcb-image0 \
  libxcb-keysyms1 \
  libxcb-randr0 \
  libxcb-render-util0 \
  libxcb-shape0
```

##### Fedora
```bash
sudo dnf install \
  mesa-libGL \
  libxcb \
  xcb-util-image \
  xcb-util-keysyms \
  xcb-util-renderutil \
  xcb-util-wm
```

---

## 配置说明

### 1. 环境变量配置

创建 `.env` 文件（不要提交到 Git）：

```bash
# .env 文件内容
# 应用环境
APP_ENV=development  # development / production / testing

# 数据库配置
DATABASE_URL=sqlite:///./data/database.db

# 加密密钥（生产环境务必修改）
ENCRYPTION_KEY=your-secret-key-change-this-in-production

# OTA 更新服务器
UPDATE_SERVER_URL=https://your-update-server.com/api
UPDATE_CHECK_INTERVAL=3600  # 秒

# 日志配置
LOG_LEVEL=DEBUG  # DEBUG / INFO / WARNING / ERROR
LOG_FILE=logs/eaip_viewer.log

# QML 调试
QML_DEBUG=1  # 开发时启用
QML_HOT_RELOAD=0  # 热重载功能（实验性）
```

### 2. 配置文件结构

```
config/
├── config.yaml           # 主配置文件
├── config.dev.yaml       # 开发环境配置
├── config.prod.yaml      # 生产环境配置
└── logging.yaml          # 日志配置
```

### 3. 初始化数据库

```bash
# 运行数据库迁移脚本
python scripts/init_database.py

# 或使用 Alembic 迁移
alembic upgrade head
```

---

## 运行调试

### 开发模式运行

#### 方式一：直接运行
```bash
python src/main.py
```

#### 方式二：模块方式运行（推荐）
```bash
python -m src.main
```

#### 方式三：调试模式
```bash
# 启用详细日志
python src/main.py --debug

# 指定日志级别
python src/main.py --log-level DEBUG
```

### QML 开发模式

```bash
# 启用 QML 调试器
QT_QML_DEBUG=1 python src/main.py

# QML 热重载（需要配置 qml-hot-reload）
python src/main.py --hot-reload
```

### IDE 配置

#### VS Code
创建 `.vscode/launch.json`：
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Python: EAIP Viewer",
      "type": "python",
      "request": "launch",
      "module": "src.main",
      "console": "integratedTerminal",
      "env": {
        "PYTHONPATH": "${workspaceFolder}",
        "QT_QML_DEBUG": "1"
      }
    }
  ]
}
```

#### PyCharm
1. 打开 Run → Edit Configurations
2. 添加 Python 配置
3. Script path: `src/main.py`
4. Working directory: 项目根目录
5. Environment variables: `QT_QML_DEBUG=1`

---

## 生产环境打包

### Windows 打包

#### 1. 准备打包配置

创建 `build_scripts/windows.spec`（已在 README 中提供）

#### 2. 执行打包

```bash
# 单文件模式（推荐分发）
pyinstaller build_scripts/windows.spec

# 或使用命令行参数
pyinstaller --windowed ^
  --name EAIP_Viewer ^
  --icon=resources/icons/app.ico ^
  --add-data "src/qml;qml" ^
  --add-data "resources;resources" ^
  --hidden-import=PyQt6.QtQml ^
  --hidden-import=PyQt6.QtQuick ^
  src/main.py
```

#### 3. 输出位置
- 打包产物: `dist/EAIP_Viewer.exe`
- 中间文件: `build/`（可删除）

#### 4. 创建安装包（可选）

使用 **Inno Setup**：
```bash
# 下载 Inno Setup
https://jrsoftware.org/isdl.php

# 编译安装脚本
iscc build_scripts/windows_installer.iss
```

### macOS 打包

#### 1. 执行打包
```bash
pyinstaller build_scripts/macos.spec
```

#### 2. 代码签名（需要 Apple 开发者证书）
```bash
# 签名应用
codesign --deep --force --verify --verbose \
  --sign "Developer ID Application: Your Name (TEAM_ID)" \
  --options runtime \
  dist/EAIP_Viewer.app

# 验证签名
codesign --verify --deep --strict --verbose=2 dist/EAIP_Viewer.app
```

#### 3. 公证（Notarization）
```bash
# 创建 DMG
hdiutil create -volname "EAIP Viewer" \
  -srcfolder dist/EAIP_Viewer.app \
  -ov -format UDZO dist/EAIP_Viewer.dmg

# 提交公证
xcrun notarytool submit dist/EAIP_Viewer.dmg \
  --apple-id "your@email.com" \
  --team-id "TEAM_ID" \
  --password "app-specific-password" \
  --wait

# 装订公证票据
xcrun stapler staple dist/EAIP_Viewer.dmg
```

### Linux 打包

#### AppImage（推荐）
```bash
# 打包应用
pyinstaller build_scripts/linux.spec

# 创建 AppImage
appimagetool dist/EAIP_Viewer/ EAIP_Viewer-x86_64.AppImage

# 添加可执行权限
chmod +x EAIP_Viewer-x86_64.AppImage
```

#### DEB 包（Debian/Ubuntu）
```bash
# 安装 fpm
gem install fpm

# 创建 DEB 包
fpm -s dir -t deb \
  -n eaip-viewer \
  -v 1.0.0 \
  --prefix /opt/eaip-viewer \
  --description "Electronic Aeronautical Information Publication Viewer" \
  --url "https://github.com/cg8-5712/EAIP_Viewer" \
  --maintainer "your@email.com" \
  --license "MIT" \
  dist/EAIP_Viewer
```

#### RPM 包（Fedora/RHEL）
```bash
fpm -s dir -t rpm \
  -n eaip-viewer \
  -v 1.0.0 \
  --prefix /opt/eaip-viewer \
  --description "Electronic Aeronautical Information Publication Viewer" \
  --url "https://github.com/cg8-5712/EAIP_Viewer" \
  --maintainer "your@email.com" \
  --license "MIT" \
  dist/EAIP_Viewer
```

---

## 常见问题排查

### 依赖安装问题

#### 问题 1: pip 下载速度慢
**解决方案**：使用国内镜像源
```bash
# 临时使用
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple package_name

# 永久配置
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

#### 问题 2: cryptography 安装失败（Windows）
**原因**：缺少 Visual C++ 编译器

**解决方案**：
1. 下载并安装 [Visual C++ Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/)
2. 或安装完整的 Visual Studio 2019+

#### 问题 3: PyQt6 导入错误
**错误信息**：`ImportError: DLL load failed while importing QtCore`

**解决方案**：
- Windows: 安装 [Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)
- Linux: 安装系统级 Qt 依赖（见上文"平台特定依赖"）

### 运行时问题

#### 问题 4: QML 文件找不到
**错误信息**：`file:///path/to/main.qml:1:1: module "QtQuick" is not installed`

**解决方案**：
```bash
# 确认 PyQt6 完整安装
pip install --force-reinstall PyQt6 PyQt6-Qt6

# 检查 Qt 插件路径
python -c "from PyQt6.QtCore import QLibraryInfo; print(QLibraryInfo.path(QLibraryInfo.LibraryPath.PluginsPath))"
```

#### 问题 5: 数据库锁定错误
**错误信息**：`sqlite3.OperationalError: database is locked`

**解决方案**：
- 确保没有多个进程同时访问数据库
- 检查是否有僵尸进程占用数据库文件
- 删除 `data/database.db-journal` 文件（如果存在）

#### 问题 6: 防截图功能无效
**原因**：不同平台实现机制不同

**检查方法**：
- Windows: 确认使用 Windows 10 1809+ 版本
- macOS: 确认应用有屏幕录制权限（系统偏好设置 → 安全性与隐私）
- Linux: X11 环境支持有限，Wayland 需要额外配置

### 打包问题

#### 问题 7: PyInstaller 打包后无法运行
**解决方案**：
```bash
# 清除缓存
pyinstaller --clean build_scripts/windows.spec

# 查看详细日志
dist/EAIP_Viewer.exe --debug
```

#### 问题 8: 打包后找不到 QML 文件
**原因**：QML 文件未正确添加到 spec 文件

**解决方案**：
检查 `windows.spec` 中的 `datas` 配置：
```python
datas=[
    ('src/qml', 'qml'),      # 确保路径正确
    ('resources', 'resources'),
],
```

#### 问题 9: 打包体积过大
**优化方案**：
```python
# 在 spec 文件中排除不需要的模块
excludes=[
    'tkinter',
    'matplotlib',
    'numpy.testing',
    'PIL.ImageQt',
],

# 启用 UPX 压缩（需要安装 UPX）
upx=True,
upx_exclude=['vcruntime140.dll', 'python3.dll'],
```

### 性能问题

#### 问题 10: 应用启动缓慢
**优化方案**：
1. 使用 PyInstaller 的 `--onefile` 模式（首次启动会慢，后续正常）
2. 延迟加载非核心模块
3. 优化 QML 文件加载顺序

#### 问题 11: PDF 渲染卡顿
**优化方案**：
1. 启用 PDF 缓存
2. 降低渲染 DPI（默认 150，可调整至 120）
3. 使用多线程渲染

---

## 验证安装

### 运行测试套件

```bash
# 运行所有测试
pytest tests/

# 运行特定测试
pytest tests/test_encryption.py -v

# 查看测试覆盖率
pytest --cov=src --cov-report=html
open htmlcov/index.html
```

### 检查依赖完整性

```bash
# 查看已安装的包
pip list

# 检查依赖冲突
pip check

# 导出当前环境依赖（用于复现环境）
pip freeze > requirements_lock.txt
```

---

## 下一步

安装完成后，请参考以下文档继续：
- [用户操作手册](./02-用户操作手册.md) - 了解如何使用应用
- [开发指南](./03-开发指南.md) - 开始开发新功能
- [架构设计](./04-架构设计文档.md) - 深入了解系统架构

---

## 获取帮助

如遇到未列出的问题：
1. 查看 [GitHub Issues](https://github.com/cg8-5712/EAIP_Viewer/issues)
2. 提交新的 Issue（附上错误日志和系统信息）
3. 联系开发者: 5712.cg8@gmail.com