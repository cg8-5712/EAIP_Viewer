# 混合安全方案使用指南

## 概述

混合安全方案提供在线/离线自适应认证，确保数据安全的同时支持离线使用。

---

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        服务器端                              │
│  ├─ 认证服务器（Flask/Django/FastAPI）                       │
│  ├─ 用户数据库（username, hashed_password, permissions）     │
│  └─ Distribution Password（打包密码，服务器保密）            │
└──────────────────┬──────────────────────────────────────────┘
                   │ HTTPS
                   ▼
┌─────────────────────────────────────────────────────────────┐
│                        客户端                                │
│  ├─ HybridSecurityManager（混合安全管理器）                 │
│  ├─ .aipkg 文件（用 Distribution Password 加密）            │
│  ├─ 离线凭证缓存（加密存储，7天有效）                        │
│  └─ 设备指纹（设备绑定）                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 快速开始

### 1. 服务器端部署

#### 启动测试服务器

```bash
# 安装依赖
pip install flask flask-cors pyjwt

# 启动服务器
python examples/auth_server.py
```

服务器将在 `http://localhost:8000` 启动

#### 测试账号

| 用户名 | 密码 | 权限 |
|--------|------|------|
| testuser | TestPassword123! | view_charts |
| admin | Admin123! | view_charts, manage_users |

---

### 2. 客户端集成

#### 步骤 1：初始化安全系统

```python
from src.core.hybrid_security import init_security

# 设置 Distribution Password（打包时的密码）
DISTRIBUTION_PASSWORD = "YourPackagingPassword123!"

# 初始化
init_security(
    distribution_password=DISTRIBUTION_PASSWORD,
    server_url="http://localhost:8000"  # 生产环境改为实际URL
)
```

#### 步骤 2：用户登录

```python
from src.core.hybrid_security import get_security_manager

# 获取安全管理器
manager = get_security_manager()

# 用户登录
username = "testuser"
password = "TestPassword123!"

if manager.authenticate(username, password):
    print("✅ 登录成功")
    print(f"当前用户: {manager.get_current_user()}")
    print(f"在线模式: {manager.is_online_mode}")
else:
    print("❌ 登录失败")
```

#### 步骤 3：解密 AIPKG

```python
# 获取 Distribution Password（用于解密）
dist_password = manager.get_distribution_password()

# 使用 AIPKG Manager 加载包
from src.core.aipkg_manager import AIPKGManager

aipkg_manager = AIPKGManager()
package = aipkg_manager.load_package(
    "packages/eaip-2507.aipkg",
    password=dist_password
)
```

---

## 完整流程示例

### 场景 1：首次在线登录

```python
from src.core.hybrid_security import HybridSecurityManager

# 1. 创建管理器
manager = HybridSecurityManager(
    server_url="http://localhost:8000",
    offline_cache_days=7  # 离线凭证有效期7天
)

# 2. 设置 Distribution Password
manager.set_distribution_password("YourPackagingPassword123!")

# 3. 用户登录（在线）
username = "testuser"
password = "TestPassword123!"

if manager.authenticate(username, password):
    # 登录成功
    # - 服务器验证通过
    # - 凭证已缓存（用于离线使用）
    # - Distribution Key 已派生

    # 4. 获取用户信息
    user = manager.get_current_user()
    print(f"欢迎, {user['username']}!")

    # 5. 解密 AIPKG
    dist_password = manager.get_distribution_password()
    # ... 使用 dist_password 解密航图

    # 6. 登出
    manager.logout()
```

### 场景 2：离线模式

```python
# 应用重启，网络不可用

manager = HybridSecurityManager()
manager.set_distribution_password("YourPackagingPassword123!")

# 尝试登录（自动降级到离线模式）
if manager.authenticate("testuser", "TestPassword123!"):
    # 离线登录成功
    # - 使用缓存的凭证
    # - 验证密码哈希
    # - 验证设备指纹
    # - 检查是否过期

    print(f"✅ 离线登录成功")
    print(f"凭证有效期至: {manager.credential_manager.load_credential('testuser', 'TestPassword123!').expires_at}")

    # 可以正常使用航图
    dist_password = manager.get_distribution_password()
```

---

## 安全机制

### 1. 设备绑定

```python
from src.core.device_fingerprint import get_device_fingerprint, get_device_info

# 获取设备指纹
fingerprint = get_device_fingerprint()
# 输出：'3f8a9c2b1d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2'

# 获取设备详细信息
info = get_device_info()
print(info)
# {
#     'fingerprint': '3f8a9c...',
#     'machine_id': 'uuid-string',
#     'platform': 'Windows',
#     'processor': 'Intel64 Family...',
#     ...
# }
```

### 2. 密码保护

```python
# 用户密码哈希（SHA-256）
password_hash = hashlib.sha256(password.encode()).hexdigest()

# 离线凭证加密（AES-256-GCM）
# - 密钥：从密码 + 设备指纹派生
# - IV：随机生成
# - AAD：用户名
```

### 3. 时效控制

```python
# 在线 Token 有效期：1 小时（服务器控制）
# 离线凭证有效期：7 天（客户端控制）

# 检查凭证是否过期
credential = manager.credential_manager.load_credential(username, password)
if credential:
    expires_at = datetime.fromisoformat(credential.expires_at)
    if datetime.now() > expires_at:
        print("凭证已过期，需要重新在线登录")
```

---

## 配置选项

### 环境变量

在 `.env` 文件中配置：

```env
# 认证服务器URL
UPDATE_SERVER_URL=https://your-auth-server.com

# 应用版本
APP_VERSION=0.1.0

# 数据目录（用于存储凭证缓存）
DATA_DIR=./data
```

### Python 配置

```python
from src.config import config

# 修改配置
config.UPDATE_SERVER_URL = "https://your-server.com"
config.APP_VERSION = "1.0.0"
```

---

## API 参考

### HybridSecurityManager

#### 方法

| 方法 | 说明 | 返回值 |
|------|------|--------|
| `authenticate(username, password)` | 用户认证（在线/离线自适应） | bool |
| `logout()` | 用户登出 | None |
| `is_authenticated()` | 检查是否已认证 | bool |
| `get_current_user()` | 获取当前用户信息 | Dict or None |
| `get_distribution_password()` | 获取 Distribution Password | str |
| `get_device_info()` | 获取设备信息 | Dict |

#### 属性

| 属性 | 说明 | 类型 |
|------|------|------|
| `current_user` | 当前用户信息 | Dict or None |
| `current_token` | 当前 JWT Token | str or None |
| `is_online_mode` | 是否在线模式 | bool |

---

## 常见问题

### Q1: 首次使用必须联网吗？

**A**: 是的。首次登录需要联网验证并缓存凭证。之后可以离线使用 7 天。

### Q2: 离线凭证过期了怎么办？

**A**: 需要重新联网登录，刷新凭证缓存。

### Q3: 更换设备后能用吗？

**A**: 不能。离线凭证绑定设备指纹，更换设备需要重新联网登录。

### Q4: Distribution Password 泄露有什么影响？

**A**: 如果只有 Distribution Password 泄露，攻击者仍需用户密码才能认证。但建议配合代码混淆保护。

### Q5: 如何保护 Distribution Password？

**A**:
1. 使用代码混淆（PyArmor）
2. 加密存储在配置文件中
3. 从服务器动态获取（最安全）

### Q6: 忘记密码怎么办？

**A**: 通过服务器的密码重置功能。离线模式下无法重置。

---

## 生产环境部署

### 1. 服务器端

```python
# 使用生产级框架（Django/FastAPI）
# 使用真实数据库（PostgreSQL/MySQL）
# 启用 HTTPS
# 实现完整的用户管理系统
# 添加日志和监控
```

### 2. 客户端

```python
# 代码混淆（PyArmor）
# 加密配置文件
# 定期清理过期凭证
# 实现异常处理和重试机制
```

### 3. Distribution Password 管理

```python
# 方案 A：硬编码 + 混淆
DIST_PASSWORD = obfuscate("YourPassword")

# 方案 B：加密存储
with open('config.encrypted', 'rb') as f:
    encrypted = f.read()
    DIST_PASSWORD = decrypt(encrypted, device_key)

# 方案 C：服务器动态获取（需要在线）
DIST_PASSWORD = fetch_from_server(auth_token)
```

---

## 测试

### 运行示例程序

```bash
# 1. 启动测试服务器（终端1）
python examples/auth_server.py

# 2. 运行示例程序（终端2）
python examples/security_demo.py
```

### 单元测试

```bash
# TODO: 添加单元测试
pytest tests/test_hybrid_security.py
```

---

## 安全最佳实践

1. ✅ **强密码策略**：要求用户使用强密码
2. ✅ **HTTPS**：生产环境必须使用 HTTPS
3. ✅ **代码混淆**：保护 Distribution Password
4. ✅ **设备绑定**：防止凭证在不同设备使用
5. ✅ **时效控制**：限制离线使用时长
6. ✅ **日志审计**：记录所有认证操作
7. ✅ **异常检测**：监控异常登录行为

---

## 相关文档

- [航图加密方案详细设计](../docs/07-航图加密方案.md)
- [AIPKG 文件格式](../docs/aipkg-format.md)
- [用户认证系统](../docs/06-用户认证系统详细文档.md)

---

**版本**: 1.0
**最后更新**: 2025-10-01
