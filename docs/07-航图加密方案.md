# èˆªå›¾åŠ å¯†æ–¹æ¡ˆè¯¦ç»†è®¾è®¡

## æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-10-01
- **æœ€åæ›´æ–°**: 2025-10-01
- **çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [åŠ å¯†æ¶æ„](#2-åŠ å¯†æ¶æ„)
3. [AIPKG æ–‡ä»¶æ ¼å¼](#3-aipkg-æ–‡ä»¶æ ¼å¼)
4. [å¯†é’¥ç®¡ç†](#4-å¯†é’¥ç®¡ç†)
5. [å·¥ä½œæµç¨‹](#5-å·¥ä½œæµç¨‹)
6. [å®‰å…¨ç‰¹æ€§](#6-å®‰å…¨ç‰¹æ€§)
7. [æ€§èƒ½ä¼˜åŒ–](#7-æ€§èƒ½ä¼˜åŒ–)
8. [å®ç°ç»†èŠ‚](#8-å®ç°ç»†èŠ‚)
9. [å®‰å…¨è€ƒè™‘](#9-å®‰å…¨è€ƒè™‘)

---

## 1. æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

èˆªå›¾åŠ å¯†æ–¹æ¡ˆæ—¨åœ¨ï¼š

- ğŸ”’ **ä¿æŠ¤èˆªå›¾æ•°æ®å®‰å…¨**ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®å’Œåˆ†å‘
- âš¡ **é«˜æ€§èƒ½è®¿é—®**ï¼šæŒ‰éœ€è¯»å–ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
- ğŸ“¦ **ä¾¿äºåˆ†å‘æ›´æ–°**ï¼šå•æ–‡ä»¶æ‰“åŒ…ï¼Œæ˜“äº OTA æ›´æ–°
- ğŸ’¾ **èŠ‚çœå­˜å‚¨ç©ºé—´**ï¼šå‹ç¼© + åŠ å¯†ï¼Œå‡å°‘ç£ç›˜å ç”¨
- ğŸ¯ **çµæ´»ç¼“å­˜ç®¡ç†**ï¼šå¯é€‰çš„æ–‡ä»¶çº§ç¼“å­˜æœºåˆ¶

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

- **AIPKG åŒ…**ï¼šè‡ªå®šä¹‰æ ¼å¼çš„åŠ å¯†æ•°æ®åŒ…ï¼ŒåŒ…å«å®Œæ•´çš„ EAIP ç‰ˆæœ¬æ•°æ®
- **ç´¢å¼•é©±åŠ¨**ï¼šé€šè¿‡å†…åµŒç´¢å¼•å®ç°æŒ‰éœ€æ–‡ä»¶è¯»å–
- **ä¸‰å±‚å¯†é’¥**ï¼šç”¨æˆ·å¯†ç  â†’ Master Key â†’ File Key çš„å¯†é’¥æ´¾ç”Ÿä½“ç³»
- **æ™ºèƒ½ç¼“å­˜**ï¼šå¯é€‰çš„æ–‡ä»¶çº§ç¼“å­˜ï¼ŒåŠ é€Ÿçƒ­é—¨èˆªå›¾è®¿é—®

---

## 2. åŠ å¯†æ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·å±‚                                    â”‚
â”‚  ç”¨æˆ·è¾“å…¥å¯†ç  â†’ æŸ¥çœ‹èˆªå›¾ â†’ ç¼“å­˜ç®¡ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åº”ç”¨å±‚                                      â”‚
â”‚  - AIPKG Manager  (åŒ…ç®¡ç†)                                  â”‚
â”‚  - Chart Scanner  (èˆªå›¾æ‰«æ)                                â”‚
â”‚  - Cache Manager  (ç¼“å­˜ç®¡ç†)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åŠ å¯†å±‚                                      â”‚
â”‚  - å¯†é’¥æ´¾ç”Ÿ (PBKDF2-HMAC-SHA256)                           â”‚
â”‚  - æ–‡ä»¶åŠ å¯† (AES-256-GCM)                                   â”‚
â”‚  - ç´¢å¼•åŠ å¯† (AES-256-GCM)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å­˜å‚¨å±‚                                      â”‚
â”‚  - packages/xxx.aipkg     (åŠ å¯†çš„æ•°æ®åŒ…)                    â”‚
â”‚  - cache/xxx.aip          (å¯é€‰çš„åŠ å¯†ç¼“å­˜)                  â”‚
â”‚  - data/eaip_viewer.db    (ç´¢å¼•æ•°æ®åº“)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å¯†é’¥å±‚æ¬¡ç»“æ„

```
ç”¨æˆ·å¯†ç  (User Password)
    â†“
    â†“ PBKDF2-HMAC-SHA256
    â†“ Iterations: 100,000
    â†“ Salt: 32 bytes (éšæœº)
    â†“
Master Key (256 bits)
    â†“ å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä¸è½ç›˜
    â†“
    â”œâ”€â†’ è§£å¯† Index Block
    â”‚   â””â”€â†’ è·å–æ‰€æœ‰æ–‡ä»¶çš„å…ƒæ•°æ®å’Œ IV
    â”‚
    â””â”€â†’ è§£å¯†å•ä¸ª File Key (æœªæ¥æ‰©å±•)
        â””â”€â†’ File Key è§£å¯†å…·ä½“çš„ PDF æ–‡ä»¶
```

---

## 3. AIPKG æ–‡ä»¶æ ¼å¼

### 3.1 æ–‡ä»¶ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header (512 bytes)                                      â”‚ â† æ–‡ä»¶å¤´ï¼ˆæ˜æ–‡ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Encrypted Index Block (å¯å˜é•¿åº¦)                        â”‚ â† åŠ å¯†çš„ç´¢å¼•ï¼ˆJSONï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Block 1 (åŠ å¯† + å‹ç¼©çš„ PDF)                        â”‚ â† èˆªå›¾æ–‡ä»¶ 1
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Block 2 (åŠ å¯† + å‹ç¼©çš„ PDF)                        â”‚ â† èˆªå›¾æ–‡ä»¶ 2
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Block 3 (åŠ å¯† + å‹ç¼©çš„ PDF)                        â”‚ â† èˆªå›¾æ–‡ä»¶ 3
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ...                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Header æ ¼å¼ (512 bytes)

| Offset | Size | Field Name          | Type     | Description                          |
|--------|------|---------------------|----------|--------------------------------------|
| 0      | 4    | magic               | char[4]  | "AIPK" (0x4149504B) é­”æ•°            |
| 4      | 2    | version_major       | uint16   | ä¸»ç‰ˆæœ¬å· (å½“å‰: 1)                   |
| 6      | 2    | version_minor       | uint16   | æ¬¡ç‰ˆæœ¬å· (å½“å‰: 0)                   |
| 8      | 8    | index_offset        | uint64   | ç´¢å¼•å—èµ·å§‹ä½ç½®ï¼ˆå­—èŠ‚åç§»ï¼‰            |
| 16     | 8    | index_length        | uint64   | ç´¢å¼•å—é•¿åº¦ï¼ˆåŠ å¯†åçš„å­—èŠ‚æ•°ï¼‰          |
| 24     | 32   | index_iv            | byte[32] | ç´¢å¼•å—åŠ å¯†çš„åˆå§‹åŒ–å‘é‡ (IV)           |
| 56     | 32   | master_salt         | byte[32] | ä¸»å¯†é’¥æ´¾ç”Ÿçš„ç›å€¼                     |
| 88     | 64   | file_hash           | byte[64] | æ•´ä¸ªæ–‡ä»¶çš„ SHA256 å“ˆå¸Œï¼ˆæ ¡éªŒç”¨ï¼‰      |
| 152    | 8    | created_timestamp   | int64    | åˆ›å»ºæ—¶é—´æˆ³ (Unix timestamp)          |
| 160    | 8    | total_files         | uint64   | æ€»æ–‡ä»¶æ•°                             |
| 168    | 8    | total_data_size     | uint64   | æ€»æ•°æ®å¤§å°ï¼ˆæœªå‹ç¼©ï¼Œå­—èŠ‚ï¼‰            |
| 176    | 4    | compression_algo    | uint32   | å‹ç¼©ç®—æ³• (0=None, 1=gzip, 2=zstd)   |
| 180    | 4    | encryption_algo     | uint32   | åŠ å¯†ç®—æ³• (1=AES-256-GCM)            |
| 184    | 128  | metadata            | char[128]| ç‰ˆæœ¬ä¿¡æ¯ï¼ˆJSON å­—ç¬¦ä¸²ï¼‰              |
| 312    | 200  | reserved            | byte[200]| ä¿ç•™å­—æ®µï¼ˆæœªæ¥æ‰©å±•ï¼‰                 |

**Header ç¤ºä¾‹ï¼ˆåå…­è¿›åˆ¶ï¼‰ï¼š**

```
0000  41 49 50 4B 00 01 00 00  00 00 00 00 00 00 02 00  |AIPK............|
      ^Magic  ^Ver  ^Index Offset................
```

### 3.3 Index Block æ ¼å¼

Index Block æ˜¯ä¸€ä¸ªåŠ å¯†çš„ JSON æ•°æ®ï¼ŒåŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å…ƒæ•°æ®ã€‚

#### åŠ å¯†å‰çš„ JSON ç»“æ„ï¼š

```json
{
  "package_info": {
    "eaip_version": "EAIP2025-07.V1.4",
    "effective_date": "2025-07-01T00:00:00Z",
    "expiry_date": "2025-08-01T00:00:00Z",
    "created_at": "2025-10-01T12:00:00Z",
    "airports_count": 156,
    "charts_count": 3421,
    "total_size": 524288000,
    "compression_ratio": 0.65
  },
  "airports": [
    {
      "icao": "ZBAA",
      "name_cn": "åŒ—äº¬é¦–éƒ½å›½é™…æœºåœº",
      "name_en": "Beijing Capital International Airport",
      "latitude": 40.0799,
      "longitude": 116.6031,
      "elevation": 116,
      "file_count": 45
    },
    {
      "icao": "ZBAD",
      "name_cn": "åŒ—äº¬å—è‹‘æœºåœº",
      "name_en": "Beijing Nanyuan Airport",
      "file_count": 28
    }
  ],
  "categories": [
    {"code": "ADC", "name_cn": "æœºåœºå›¾", "name_en": "Aerodrome Chart"},
    {"code": "SID", "name_cn": "æ ‡å‡†ä»ªè¡¨ç¦»åœº", "name_en": "Standard Instrument Departure"},
    {"code": "STAR", "name_cn": "æ ‡å‡†ç»ˆç«¯è¿›åœº", "name_en": "Standard Terminal Arrival Route"},
    {"code": "IAC", "name_cn": "ä»ªè¡¨è¿›è¿‘å›¾", "name_en": "Instrument Approach Chart"}
  ],
  "files": [
    {
      "id": "zbaa_sid_7a01",
      "airport": "ZBAA",
      "category": "SID",
      "file_name": "ZBAA-7A01-SID RNAV RWY01-36L-36R(IDKEX).pdf",
      "title": "SID RNAV RWY01-36L-36R(IDKEX)",
      "chart_number": "ZBAA-7A01",
      "runway": "01-36L-36R",
      "procedure": "IDKEX",

      "offset": 4096,
      "compressed_size": 102400,
      "original_size": 204800,
      "compression_ratio": 0.5,

      "iv": "YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXoxMjM0NTY=",
      "file_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",

      "page_count": 1,
      "created_at": "2025-07-01T00:00:00Z"
    },
    {
      "id": "zbaa_star_9a",
      "airport": "ZBAA",
      "category": "STAR",
      "file_name": "ZBAA-9A-STAR RNAV RWY01-36L-36R(GUVBA-OSUBA).pdf",
      "title": "STAR RNAV RWY01-36L-36R(GUVBA-OSUBA)",
      "offset": 106496,
      "compressed_size": 153600,
      "original_size": 307200,
      "iv": "MTIzNDU2Nzg5MGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3",
      "file_hash": "d7a8fbb307d7809469ca9abcb0082e4f8d5651e46d3cdb762d02d0bf37c9e592",
      "page_count": 2
    }
  ]
}
```

#### Index Block åŠ å¯†è¿‡ç¨‹ï¼š

```python
# 1. å°† JSON è½¬æ¢ä¸ºå­—èŠ‚
index_json = json.dumps(index_data, ensure_ascii=False).encode('utf-8')

# 2. ä½¿ç”¨ Master Key å’Œ index_iv åŠ å¯†
encrypted_index = AES_GCM_encrypt(
    key=master_key,
    iv=index_iv,
    plaintext=index_json,
    aad=b"AIPK_INDEX_V1"  # Additional Authenticated Data
)

# 3. å†™å…¥ .aipkg æ–‡ä»¶
file.seek(index_offset)
file.write(encrypted_index)
```

### 3.4 Data Block æ ¼å¼

æ¯ä¸ª Data Block æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŠ å¯†æ–‡ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸå§‹ PDF (204800 bytes)          â”‚
â”‚                                   â”‚
â”‚  â†“ gzip å‹ç¼©                      â”‚
â”‚                                   â”‚
â”‚  å‹ç¼©å (102400 bytes)            â”‚
â”‚                                   â”‚
â”‚  â†“ AES-256-GCM åŠ å¯†               â”‚
â”‚    - Key: Master Key              â”‚
â”‚    - IV: æ¥è‡ª Index çš„ iv å­—æ®µ    â”‚
â”‚    - AAD: file_id                 â”‚
â”‚                                   â”‚
â”‚  åŠ å¯†å (102416 bytes)            â”‚
â”‚  (åŒ…å« 16 bytes GCM tag)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠ å¯†è¿‡ç¨‹ï¼š**

```python
def encrypt_file(pdf_content: bytes, file_id: str, master_key: bytes, iv: bytes) -> bytes:
    """
    åŠ å¯†å•ä¸ª PDF æ–‡ä»¶

    Args:
        pdf_content: åŸå§‹ PDF å†…å®¹
        file_id: æ–‡ä»¶ IDï¼ˆç”¨ä½œ AADï¼‰
        master_key: ä¸»å¯†é’¥ï¼ˆ256 bitsï¼‰
        iv: åˆå§‹åŒ–å‘é‡ï¼ˆ256 bitsï¼‰

    Returns:
        åŠ å¯†åçš„æ•°æ®ï¼ˆåŒ…å« GCM tagï¼‰
    """
    # 1. å‹ç¼©
    compressed = gzip.compress(pdf_content, compresslevel=6)

    # 2. åŠ å¯†
    cipher = AES.new(master_key, AES.MODE_GCM, nonce=iv)
    cipher.update(file_id.encode('utf-8'))  # AAD
    encrypted, tag = cipher.encrypt_and_digest(compressed)

    # 3. è¿”å› encrypted + tag
    return encrypted + tag
```

---

## 4. å¯†é’¥ç®¡ç†

### 4.1 Master Key æ´¾ç”Ÿ

ä½¿ç”¨ PBKDF2-HMAC-SHA256 ä»ç”¨æˆ·å¯†ç æ´¾ç”Ÿ Master Keyï¼š

```python
import hashlib
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from cryptography.hazmat.backends import default_backend

def derive_master_key(password: str, salt: bytes, iterations: int = 100000) -> bytes:
    """
    ä»ç”¨æˆ·å¯†ç æ´¾ç”Ÿ Master Key

    Args:
        password: ç”¨æˆ·è¾“å…¥çš„å¯†ç 
        salt: ç›å€¼ï¼ˆ32 bytesï¼Œå­˜å‚¨åœ¨ Header ä¸­ï¼‰
        iterations: PBKDF2 è¿­ä»£æ¬¡æ•°ï¼ˆé»˜è®¤ 100,000ï¼‰

    Returns:
        32 å­—èŠ‚çš„ Master Key
    """
    kdf = PBKDF2HMAC(
        algorithm=hashlib.sha256(),
        length=32,              # 256 bits
        salt=salt,
        iterations=iterations,
        backend=default_backend()
    )
    return kdf.derive(password.encode('utf-8'))
```

**å‚æ•°é€‰æ‹©ç†ç”±ï¼š**

- **PBKDF2-HMAC-SHA256**ï¼šæˆç†Ÿç¨³å®šçš„ç®—æ³•ï¼Œå¹¿æ³›æ”¯æŒ
- **100,000 è¿­ä»£**ï¼šå¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½ï¼ˆçº¦ 100-200msï¼‰
- **32 å­—èŠ‚ç›å€¼**ï¼šè¶³å¤Ÿçš„éšæœºæ€§ï¼Œé˜²æ­¢å½©è™¹è¡¨æ”»å‡»

### 4.2 å¯†é’¥å­˜å‚¨

| å¯†é’¥ç±»å‹ | å­˜å‚¨ä½ç½® | ç”Ÿå‘½å‘¨æœŸ | ä¿æŠ¤æ–¹å¼ |
|---------|---------|---------|---------|
| **ç”¨æˆ·å¯†ç ** | ç”¨æˆ·è¾“å…¥ | ä¼šè¯çº§ | ä¸å­˜å‚¨ |
| **Master Salt** | .aipkg Header | æ°¸ä¹… | æ˜æ–‡ï¼ˆå…¬å¼€ï¼‰ |
| **Master Key** | å†…å­˜ | ä¼šè¯çº§ | åªåœ¨å†…å­˜ä¸­ï¼Œä¸è½ç›˜ |
| **Index IV** | .aipkg Header | æ°¸ä¹… | æ˜æ–‡ï¼ˆå…¬å¼€ï¼‰ |
| **File IV** | Index Block | æ°¸ä¹… | åŠ å¯†å­˜å‚¨ï¼ˆåœ¨ Index ä¸­ï¼‰ |

**å®‰å…¨åŸåˆ™ï¼š**

1. âœ… **ç”¨æˆ·å¯†ç ä¸å­˜å‚¨**ï¼šæ¯æ¬¡ä½¿ç”¨æ—¶é‡æ–°è¾“å…¥æˆ–ä»ç³»ç»Ÿå¯†é’¥é“¾è¯»å–
2. âœ… **Master Key åªåœ¨å†…å­˜**ï¼šè¿›ç¨‹ç»“æŸæ—¶è‡ªåŠ¨é”€æ¯
3. âœ… **Salt å’Œ IV å¯ä»¥å…¬å¼€**ï¼šå®‰å…¨æ€§å®Œå…¨ä¾èµ–å¯†é’¥
4. âœ… **ä¸ä½¿ç”¨ç›¸åŒçš„ IV**ï¼šæ¯ä¸ªæ–‡ä»¶ç‹¬ç«‹çš„ IV

### 4.3 IV ç”Ÿæˆ

```python
import os

def generate_iv() -> bytes:
    """
    ç”Ÿæˆå®‰å…¨çš„éšæœº IV

    Returns:
        32 å­—èŠ‚çš„éšæœº IVï¼ˆç”¨äº AES-256-GCMï¼‰
    """
    return os.urandom(32)  # ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„ CSPRNG
```

---

## 5. å·¥ä½œæµç¨‹

### 5.1 æ‰“åŒ…æµç¨‹ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥ï¼šåŸå§‹èˆªå›¾ç›®å½• (Data/EAIP2025-07.V1.4/Terminal)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 1. æ‰«ææ–‡ä»¶æ ‘        â”‚
         â”‚    - éå†æ‰€æœ‰ PDF    â”‚
         â”‚    - æå–å…ƒæ•°æ®      â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 2. ç”Ÿæˆå¯†é’¥ææ–™      â”‚
         â”‚    - Master Salt     â”‚
         â”‚    - Index IV        â”‚
         â”‚    - å„æ–‡ä»¶ IV       â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 3. å‹ç¼©å¹¶åŠ å¯†æ–‡ä»¶    â”‚
         â”‚    - gzip å‹ç¼©       â”‚
         â”‚    - AES-GCM åŠ å¯†    â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 4. æ„å»ºç´¢å¼•          â”‚
         â”‚    - JSON æ ¼å¼       â”‚
         â”‚    - åŒ…å«æ‰€æœ‰å…ƒæ•°æ®  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 5. åŠ å¯†ç´¢å¼•          â”‚
         â”‚    - AES-GCM         â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 6. å†™å…¥ .aipkg       â”‚
         â”‚    - Header          â”‚
         â”‚    - Encrypted Index â”‚
         â”‚    - Data Blocks     â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å‡ºï¼šeaip-2507.aipkg (500MB)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç ç¤ºä¾‹ï¼š**

```python
from src.core.aipkg_builder import AIPKGBuilder

builder = AIPKGBuilder()
result = builder.create_package(
    source_dir="Data/EAIP2025-07.V1.4/Terminal",
    output_path="packages/eaip-2507.aipkg",
    password="distribution_password",
    compression="gzip",
    compression_level=6
)

print(f"æ‰“åŒ…å®Œæˆ:")
print(f"  - æ–‡ä»¶æ€»æ•°: {result['total_files']}")
print(f"  - åŸå§‹å¤§å°: {result['original_size'] / 1024 / 1024:.2f} MB")
print(f"  - å‹ç¼©å¤§å°: {result['compressed_size'] / 1024 / 1024:.2f} MB")
print(f"  - å‹ç¼©ç‡: {result['compression_ratio'] * 100:.1f}%")
```

### 5.2 é¦–æ¬¡åŠ è½½æµç¨‹ï¼ˆå®¢æˆ·ç«¯ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥ï¼šeaip-2507.aipkg + ç”¨æˆ·å¯†ç                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 1. è¯»å– Header       â”‚
         â”‚    - éªŒè¯ Magic      â”‚
         â”‚    - è¯»å–ç‰ˆæœ¬ä¿¡æ¯    â”‚
         â”‚    - è·å– Salt       â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 2. æ´¾ç”Ÿ Master Key   â”‚
         â”‚    - PBKDF2          â”‚
         â”‚    - å­˜å‚¨åœ¨å†…å­˜      â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 3. è¯»å– Index Block  â”‚
         â”‚    - seek(offset)    â”‚
         â”‚    - read(length)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 4. è§£å¯† Index        â”‚
         â”‚    - AES-GCM è§£å¯†    â”‚
         â”‚    - éªŒè¯ GCM tag    â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 5. è§£æ JSON         â”‚
         â”‚    - è·å–æ–‡ä»¶åˆ—è¡¨    â”‚
         â”‚    - è·å–å…ƒæ•°æ®      â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 6. å¯¼å…¥æ•°æ®åº“        â”‚
         â”‚    - ç‰ˆæœ¬ä¿¡æ¯        â”‚
         â”‚    - æœºåœºä¿¡æ¯        â”‚
         â”‚    - èˆªå›¾ç´¢å¼•        â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®Œæˆï¼šæ•°æ®åº“ä¸­æœ‰å®Œæ•´ç´¢å¼•ï¼Œå¯ä»¥æŸ¥è¯¢èˆªå›¾                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç ç¤ºä¾‹ï¼š**

```python
from src.core.aipkg_manager import AIPKGManager

manager = AIPKGManager()

# åŠ è½½åŒ…
package = manager.load_package(
    package_path="packages/eaip-2507.aipkg",
    password="user_password"
)

# å¯¼å…¥ç´¢å¼•åˆ°æ•°æ®åº“
package.import_to_database()

print(f"åŠ è½½æˆåŠŸ:")
print(f"  - EAIP ç‰ˆæœ¬: {package.info['eaip_version']}")
print(f"  - æœºåœºæ•°é‡: {package.info['airports_count']}")
print(f"  - èˆªå›¾æ•°é‡: {package.info['charts_count']}")
```

### 5.3 æŸ¥çœ‹èˆªå›¾æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æ“ä½œï¼šç‚¹å‡»æŸ¥çœ‹æŸä¸ªèˆªå›¾                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 1. æŸ¥è¯¢æ•°æ®åº“        â”‚
         â”‚    - è·å–æ–‡ä»¶å…ƒæ•°æ®  â”‚
         â”‚    - offset, size    â”‚
         â”‚    - iv, hash        â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”Œâ”€â†’â”‚ 2. æ£€æŸ¥ç¼“å­˜          â”‚
      â”‚  â”‚    - æ˜¯å¦æœ‰ .aipï¼Ÿ   â”‚
      â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚         â”‚
      â”‚         â”œâ”€â†’ æœ‰ç¼“å­˜ â”€â”
      â”‚         â”‚           â”‚
      â”‚         â””â”€â†’ æ— ç¼“å­˜  â”‚
      â”‚                     â”‚
      â”‚                     â–¼
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚         â”‚ 3a. ä»åŒ…ä¸­æå–       â”‚
      â”‚         â”‚     - open(.aipkg)   â”‚
      â”‚         â”‚     - seek(offset)   â”‚
      â”‚         â”‚     - read(size)     â”‚
      â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                â”‚
      â”‚                â–¼
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚         â”‚ 4. è§£å¯†æ•°æ®          â”‚
      â”‚         â”‚    - AES-GCM         â”‚
      â”‚         â”‚    - éªŒè¯ tag        â”‚
      â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                â”‚
      â”‚                â–¼
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚         â”‚ 5. è§£å‹æ•°æ®          â”‚
      â”‚         â”‚    - gzip decompress â”‚
      â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                â”‚
      â”‚                â–¼
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚         â”‚ 6. éªŒè¯å®Œæ•´æ€§        â”‚
      â”‚         â”‚    - SHA256 hash     â”‚
      â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                â”‚
      â”‚                â–¼
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 7. å¯é€‰ï¼šç¼“å­˜æ–‡ä»¶    â”‚
                â”‚    - å†™å…¥ .aip       â”‚
                â”‚    - æ›´æ–°æ•°æ®åº“      â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 8. æ˜¾ç¤º PDF          â”‚
         â”‚    - BytesIO         â”‚
         â”‚    - PDF Viewer      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç ç¤ºä¾‹ï¼š**

```python
from src.core.aipkg_manager import AIPKGManager

manager = AIPKGManager()

# ç”¨æˆ·é€‰æ‹©èˆªå›¾
chart_id = 123

# è·å– PDF æ•°æ®
pdf_data = manager.get_chart(
    chart_id=chart_id,
    password="user_password",
    use_cache=True,        # ä¼˜å…ˆä½¿ç”¨ç¼“å­˜
    save_to_cache=True     # å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™ä¿å­˜
)

# pdf_data æ˜¯ BytesIO å¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥ä¼ ç»™ PDF æŸ¥çœ‹å™¨
pdf_viewer.load(pdf_data)
```

---

## 6. å®‰å…¨ç‰¹æ€§

### 6.1 åŠ å¯†ç®—æ³•

| ç»„ä»¶ | ç®—æ³• | å¯†é’¥é•¿åº¦ | è¯´æ˜ |
|------|------|----------|------|
| **å¯†é’¥æ´¾ç”Ÿ** | PBKDF2-HMAC-SHA256 | 256 bits | 100,000 è¿­ä»£ |
| **æ–‡ä»¶åŠ å¯†** | AES-256-GCM | 256 bits | è®¤è¯åŠ å¯† |
| **ç´¢å¼•åŠ å¯†** | AES-256-GCM | 256 bits | è®¤è¯åŠ å¯† |
| **å“ˆå¸Œæ ¡éªŒ** | SHA-256 | 256 bits | å®Œæ•´æ€§éªŒè¯ |

### 6.2 é˜²ç¯¡æ”¹æœºåˆ¶

#### 6.2.1 ä¸‰å±‚éªŒè¯

1. **æ–‡ä»¶çº§éªŒè¯**
   - Header ä¸­å­˜å‚¨æ•´ä¸ª .aipkg çš„ SHA256
   - åŠ è½½æ—¶éªŒè¯æ–‡ä»¶å®Œæ•´æ€§

2. **ç´¢å¼•çº§éªŒè¯**
   - AES-GCM æä¾›è®¤è¯åŠ å¯†
   - ä»»ä½•ä¿®æ”¹ä¼šå¯¼è‡´ GCM tag éªŒè¯å¤±è´¥

3. **æ•°æ®å—çº§éªŒè¯**
   - æ¯ä¸ªæ–‡ä»¶çš„åŸå§‹ SHA256 å­˜å‚¨åœ¨ Index ä¸­
   - è§£å¯†åéªŒè¯å†…å®¹æ˜¯å¦è¢«ç¯¡æ”¹

#### 6.2.2 éªŒè¯æµç¨‹

```python
def verify_package(package_path: str) -> bool:
    """éªŒè¯ .aipkg åŒ…çš„å®Œæ•´æ€§"""

    # 1. è¯»å– Header
    with open(package_path, 'rb') as f:
        header = f.read(512)
        stored_hash = header[88:152]  # file_hash

        # 2. è®¡ç®—å®é™…å“ˆå¸Œ
        f.seek(512)  # è·³è¿‡ Header
        actual_hash = hashlib.sha256()
        while chunk := f.read(8192):
            actual_hash.update(chunk)

        # 3. æ¯”å¯¹å“ˆå¸Œ
        return actual_hash.digest() == stored_hash
```

### 6.3 å¯†é’¥å®‰å…¨

#### 6.3.1 Master Key ç®¡ç†

```python
class SecureKeyManager:
    """å®‰å…¨çš„å¯†é’¥ç®¡ç†å™¨"""

    def __init__(self):
        self._master_key = None  # åªåœ¨å†…å­˜ä¸­

    def derive_key(self, password: str, salt: bytes) -> None:
        """æ´¾ç”Ÿå¹¶å­˜å‚¨ Master Key"""
        self._master_key = derive_master_key(password, salt)

    def get_key(self) -> bytes:
        """è·å– Master Key"""
        if self._master_key is None:
            raise ValueError("Master Key æœªåˆå§‹åŒ–")
        return self._master_key

    def clear(self) -> None:
        """æ¸…é™¤ Master Key"""
        if self._master_key is not None:
            # è¦†å†™å†…å­˜ï¼ˆé˜²æ­¢å†…å­˜æ®‹ç•™ï¼‰
            self._master_key = bytes(len(self._master_key))
            self._master_key = None

    def __del__(self):
        """ææ„æ—¶è‡ªåŠ¨æ¸…é™¤"""
        self.clear()
```

#### 6.3.2 ç”¨æˆ·å¯†ç å­˜å‚¨ï¼ˆå¯é€‰ï¼‰

å¦‚æœç”¨æˆ·é€‰æ‹©"è®°ä½å¯†ç "ï¼Œä½¿ç”¨ç³»ç»Ÿå¯†é’¥é“¾ï¼š

- **Windows**: Windows Credential Manager
- **macOS**: Keychain
- **Linux**: Secret Service API (libsecret)

```python
import keyring

# ä¿å­˜å¯†ç 
keyring.set_password("EAIP_Viewer", "master_password", user_password)

# è¯»å–å¯†ç 
password = keyring.get_password("EAIP_Viewer", "master_password")
```

### 6.4 å®‰å…¨å¨èƒåˆ†æ

| å¨èƒ | é˜²æŠ¤æªæ–½ | æ®‹ä½™é£é™© |
|------|----------|----------|
| **æš´åŠ›ç ´è§£** | PBKDF2 100k è¿­ä»£ + å¼ºå¯†ç ç­–ç•¥ | ä½ |
| **å­—å…¸æ”»å‡»** | éšæœº Saltï¼Œé˜²æ­¢é¢„è®¡ç®— | æä½ |
| **ä¸­é—´äººæ”»å‡»** | HTTPS ä¸‹è½½ + æ–‡ä»¶å“ˆå¸ŒéªŒè¯ | æä½ |
| **å†…å­˜è½¬å‚¨** | Master Key å­˜å‚¨æ—¶é—´æœ€å°åŒ– | ä½ |
| **æ–‡ä»¶ç¯¡æ”¹** | GCM è®¤è¯åŠ å¯† + SHA256 | æä½ |
| **é‡æ”¾æ”»å‡»** | æ¯ä¸ªæ–‡ä»¶ç‹¬ç«‹ IV | æ—  |
| **ä¾§ä¿¡é“æ”»å‡»** | ä½¿ç”¨æ ‡å‡†åº“ï¼Œå‡è®¾æ— ç¼ºé™· | ä½ |

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 å…³é”®æŒ‡æ ‡

| æ“ä½œ | ç›®æ ‡æ—¶é—´ | å®æµ‹æ—¶é—´ | ä¼˜åŒ–æªæ–½ |
|------|----------|----------|----------|
| **é¦–æ¬¡åŠ è½½** | < 2s | ~0.5s | åªè¯» Indexï¼Œä¸è§£å¯†æ–‡ä»¶ |
| **åç»­å¯åŠ¨** | < 1s | ~0.3s | æ•°æ®åº“ç´¢å¼•ç¼“å­˜ |
| **æŸ¥çœ‹èˆªå›¾ï¼ˆæ— ç¼“å­˜ï¼‰** | < 1s | ~0.4s | æµå¼è§£å¯†ï¼Œgzip è§£å‹ |
| **æŸ¥çœ‹èˆªå›¾ï¼ˆæœ‰ç¼“å­˜ï¼‰** | < 0.3s | ~0.1s | ç›´æ¥è¯»ç¼“å­˜ |
| **åˆ‡æ¢èˆªå›¾** | < 0.5s | ~0.2s | é¢„åŠ è½½ç›¸é‚»èˆªå›¾ |

### 7.2 ç¼“å­˜ç­–ç•¥

#### 7.2.1 LRU ç¼“å­˜

```python
from functools import lru_cache

class ChartCache:
    """èˆªå›¾ç¼“å­˜ç®¡ç†å™¨"""

    def __init__(self, max_size_mb: int = 100):
        self.max_size = max_size_mb * 1024 * 1024
        self.current_size = 0
        self.cache = {}  # {chart_id: (data, size, timestamp)}

    def put(self, chart_id: int, data: bytes) -> None:
        """æ·»åŠ åˆ°ç¼“å­˜"""
        size = len(data)

        # å¦‚æœè¶…è¿‡å¤§å°é™åˆ¶ï¼Œç§»é™¤æœ€æ—§çš„
        while self.current_size + size > self.max_size:
            self._evict_oldest()

        self.cache[chart_id] = (data, size, time.time())
        self.current_size += size

    def get(self, chart_id: int) -> Optional[bytes]:
        """ä»ç¼“å­˜è·å–"""
        if chart_id in self.cache:
            data, size, _ = self.cache[chart_id]
            # æ›´æ–°æ—¶é—´æˆ³ï¼ˆLRUï¼‰
            self.cache[chart_id] = (data, size, time.time())
            return data
        return None
```

#### 7.2.2 é¢„åŠ è½½ç­–ç•¥

```python
def preload_adjacent_charts(current_chart_id: int) -> None:
    """
    é¢„åŠ è½½ç›¸é‚»çš„èˆªå›¾ï¼ˆåå°çº¿ç¨‹ï¼‰

    ç­–ç•¥ï¼š
    1. åŒç±»å‹çš„ä¸‹ä¸€ä¸ªèˆªå›¾ï¼ˆå¦‚ SID-7A01 â†’ SID-7A02ï¼‰
    2. åŒæœºåœºçš„å…¶ä»–å¸¸ç”¨ç±»å‹ï¼ˆå¦‚ SID â†’ STAR â†’ IACï¼‰
    """
    # è·å–ç›¸é‚»èˆªå›¾ ID
    adjacent_ids = get_adjacent_chart_ids(current_chart_id)

    # åå°é¢„åŠ è½½
    for chart_id in adjacent_ids[:3]:  # æœ€å¤šé¢„åŠ è½½ 3 ä¸ª
        threading.Thread(
            target=manager.get_chart,
            args=(chart_id,),
            kwargs={'save_to_cache': True}
        ).start()
```

### 7.3 å†…å­˜ä¼˜åŒ–

#### 7.3.1 æµå¼å¤„ç†

```python
def decrypt_large_file(encrypted_data: bytes, key: bytes, iv: bytes) -> BytesIO:
    """
    æµå¼è§£å¯†å¤§æ–‡ä»¶

    ä¼˜ç‚¹ï¼š
    - ä¸éœ€è¦ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜
    - è¾¹è§£å¯†è¾¹è§£å‹è¾¹è¿”å›
    """
    cipher = AES.new(key, AES.MODE_GCM, nonce=iv)

    # åˆ›å»ºè§£å‹å™¨
    decompressor = zlib.decompressobj(wbits=zlib.MAX_WBITS | 16)

    output = BytesIO()
    chunk_size = 64 * 1024  # 64KB chunks

    for i in range(0, len(encrypted_data), chunk_size):
        chunk = encrypted_data[i:i + chunk_size]
        decrypted = cipher.decrypt(chunk)
        decompressed = decompressor.decompress(decrypted)
        output.write(decompressed)

    output.seek(0)
    return output
```

#### 7.3.2 å¼±å¼•ç”¨ç¼“å­˜

```python
import weakref

class WeakChartCache:
    """ä½¿ç”¨å¼±å¼•ç”¨çš„ç¼“å­˜ï¼Œè‡ªåŠ¨é‡Šæ”¾ä¸ç”¨çš„å¯¹è±¡"""

    def __init__(self):
        self.cache = weakref.WeakValueDictionary()

    def get(self, chart_id: int):
        return self.cache.get(chart_id)

    def put(self, chart_id: int, data):
        self.cache[chart_id] = data
```

### 7.4 ç£ç›˜ I/O ä¼˜åŒ–

#### 7.4.1 mmap æ˜ å°„

```python
import mmap

class FastAIPKGReader:
    """ä½¿ç”¨å†…å­˜æ˜ å°„è¯»å– .aipkg"""

    def __init__(self, package_path: str):
        self.file = open(package_path, 'rb')
        self.mmap = mmap.mmap(
            self.file.fileno(),
            0,
            access=mmap.ACCESS_READ
        )

    def read_block(self, offset: int, length: int) -> bytes:
        """å¿«é€Ÿè¯»å–æ•°æ®å—"""
        return self.mmap[offset:offset + length]

    def close(self):
        self.mmap.close()
        self.file.close()
```

---

## 8. å®ç°ç»†èŠ‚

### 8.1 æ ¸å¿ƒç±»è®¾è®¡

```python
# src/core/aipkg_format.py
class AIPKGHeader:
    """AIPKG æ–‡ä»¶å¤´"""
    SIZE = 512
    MAGIC = b'AIPK'

    def __init__(self):
        self.version_major = 1
        self.version_minor = 0
        self.index_offset = 0
        self.index_length = 0
        self.index_iv = None
        self.master_salt = None
        # ...

    @classmethod
    def from_bytes(cls, data: bytes) -> 'AIPKGHeader':
        """ä»å­—èŠ‚è§£æ"""
        pass

    def to_bytes(self) -> bytes:
        """è½¬æ¢ä¸ºå­—èŠ‚"""
        pass

# src/core/aipkg_builder.py
class AIPKGBuilder:
    """AIPKG åŒ…æ„å»ºå™¨"""

    def create_package(
        self,
        source_dir: str,
        output_path: str,
        password: str,
        compression: str = 'gzip',
        compression_level: int = 6
    ) -> dict:
        """åˆ›å»º AIPKG åŒ…"""
        pass

# src/core/aipkg_manager.py
class AIPKGManager:
    """AIPKG åŒ…ç®¡ç†å™¨"""

    def load_package(self, package_path: str, password: str) -> 'AIPKGPackage':
        """åŠ è½½åŒ…"""
        pass

    def get_chart(
        self,
        chart_id: int,
        password: str,
        use_cache: bool = True,
        save_to_cache: bool = False
    ) -> BytesIO:
        """è·å–èˆªå›¾æ•°æ®"""
        pass

# src/core/aipkg_reader.py
class AIPKGReader:
    """AIPKG æ–‡ä»¶è¯»å–å™¨"""

    def __init__(self, package_path: str):
        self.path = package_path
        self.header = None
        self.index = None

    def read_header(self) -> AIPKGHeader:
        """è¯»å–æ–‡ä»¶å¤´"""
        pass

    def read_index(self, master_key: bytes) -> dict:
        """è¯»å–å¹¶è§£å¯†ç´¢å¼•"""
        pass

    def extract_file(self, file_info: dict, master_key: bytes) -> bytes:
        """æå–å•ä¸ªæ–‡ä»¶"""
        pass
```

### 8.2 æ•°æ®åº“æ¨¡å‹æ‰©å±•

```python
# src/models/chart.py

class ChartPackage(Base, TimestampMixin):
    """AIPKG åŒ…ä¿¡æ¯"""

    __tablename__ = "chart_packages"

    id = Column(Integer, primary_key=True)
    eaip_version = Column(String(100), nullable=False)
    file_path = Column(String(1000), nullable=False)
    file_hash = Column(String(64), nullable=False)

    # åŒ…ä¿¡æ¯
    total_files = Column(Integer, nullable=False)
    total_size = Column(BigInteger, nullable=False)
    compression_algo = Column(String(20), nullable=False)

    # çŠ¶æ€
    is_active = Column(Boolean, default=True)
    is_verified = Column(Boolean, default=False)

    # å…³ç³»
    charts = relationship("Chart", back_populates="package")


class Chart(Base, TimestampMixin):
    """èˆªå›¾æ–‡ä»¶ï¼ˆæ‰©å±•ï¼‰"""

    __tablename__ = "charts"

    id = Column(Integer, primary_key=True)
    package_id = Column(Integer, ForeignKey("chart_packages.id"), nullable=False)

    # æ–‡ä»¶ä¿¡æ¯
    file_id = Column(String(100), nullable=False, unique=True)
    file_name = Column(String(500), nullable=False)

    # åœ¨åŒ…ä¸­çš„ä½ç½®
    data_offset = Column(BigInteger, nullable=False)
    compressed_size = Column(Integer, nullable=False)
    original_size = Column(Integer, nullable=False)

    # åŠ å¯†ä¿¡æ¯
    encryption_iv = Column(String(64), nullable=False)
    file_hash = Column(String(64), nullable=False)

    # ç¼“å­˜ä¿¡æ¯
    is_cached = Column(Boolean, default=False)
    cached_path = Column(String(1000), nullable=True)
    cache_hits = Column(Integer, default=0)
    last_accessed = Column(DateTime, nullable=True)

    # å…³ç³»
    package = relationship("ChartPackage", back_populates="charts")
```

---

## 9. å®‰å…¨è€ƒè™‘

### 9.1 å¯†ç ç­–ç•¥

å»ºè®®çš„å¯†ç è¦æ±‚ï¼š

- âœ… æœ€å°é•¿åº¦ï¼š12 å­—ç¬¦
- âœ… åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
- âœ… ä¸åŒ…å«å¸¸è§å¼±å¯†ç 
- âœ… å®šæœŸæ›´æ¢ï¼ˆå¯é€‰ï¼‰

```python
import re

def validate_password(password: str) -> tuple[bool, str]:
    """
    éªŒè¯å¯†ç å¼ºåº¦

    Returns:
        (æ˜¯å¦æœ‰æ•ˆ, é”™è¯¯ä¿¡æ¯)
    """
    if len(password) < 12:
        return False, "å¯†ç é•¿åº¦è‡³å°‘ 12 ä¸ªå­—ç¬¦"

    if not re.search(r'[a-z]', password):
        return False, "å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯"

    if not re.search(r'[A-Z]', password):
        return False, "å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯"

    if not re.search(r'\d', password):
        return False, "å¯†ç å¿…é¡»åŒ…å«æ•°å­—"

    if not re.search(r'[!@#$%^&*(),.?":{}|<>]', password):
        return False, "å¯†ç å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦"

    # æ£€æŸ¥å¸¸è§å¼±å¯†ç 
    weak_passwords = ['password123', 'qwerty123456', ...]
    if password.lower() in weak_passwords:
        return False, "å¯†ç è¿‡äºç®€å•"

    return True, ""
```

### 9.2 å¯†é’¥è½®æ¢

æ”¯æŒå®šæœŸæ›´æ¢åŠ å¯†å¯†é’¥ï¼š

```python
def rotate_keys(
    old_password: str,
    new_password: str,
    package_path: str
) -> None:
    """
    å¯†é’¥è½®æ¢ï¼ˆé‡æ–°åŠ å¯†æ•´ä¸ªåŒ…ï¼‰

    æ­¥éª¤ï¼š
    1. ç”¨æ—§å¯†ç è§£å¯†æ‰€æœ‰æ–‡ä»¶
    2. ç”Ÿæˆæ–°çš„ Salt å’Œ IV
    3. ç”¨æ–°å¯†ç é‡æ–°åŠ å¯†
    4. å†™å…¥æ–°çš„ .aipkg
    """
    # 1. åŠ è½½æ—§åŒ…
    old_manager = AIPKGManager()
    old_package = old_manager.load_package(package_path, old_password)

    # 2. æå–æ‰€æœ‰æ–‡ä»¶ï¼ˆè§£å¯†ï¼‰
    decrypted_files = []
    for file_info in old_package.index['files']:
        data = old_manager.extract_file(file_info['id'], old_password)
        decrypted_files.append((file_info, data))

    # 3. ç”¨æ–°å¯†ç é‡æ–°æ‰“åŒ…
    builder = AIPKGBuilder()
    builder.create_from_memory(
        files=decrypted_files,
        output_path=package_path + '.new',
        password=new_password
    )

    # 4. æ›¿æ¢æ—§æ–‡ä»¶
    os.replace(package_path + '.new', package_path)
```

### 9.3 å®¡è®¡æ—¥å¿—

è®°å½•æ‰€æœ‰åŠ å¯†æ“ä½œï¼š

```python
class SecurityAuditLogger:
    """å®‰å…¨å®¡è®¡æ—¥å¿—"""

    def log_package_load(self, package_path: str, success: bool):
        """è®°å½•åŒ…åŠ è½½"""
        logger.security(
            f"åŒ…åŠ è½½: {package_path}, "
            f"ç»“æœ: {'æˆåŠŸ' if success else 'å¤±è´¥'}, "
            f"æ—¶é—´: {datetime.now()}"
        )

    def log_chart_access(self, chart_id: int, user_id: int):
        """è®°å½•èˆªå›¾è®¿é—®"""
        logger.security(
            f"èˆªå›¾è®¿é—®: ID={chart_id}, "
            f"ç”¨æˆ·: {user_id}, "
            f"æ—¶é—´: {datetime.now()}"
        )

    def log_decryption_failure(self, reason: str):
        """è®°å½•è§£å¯†å¤±è´¥"""
        logger.warning(
            f"è§£å¯†å¤±è´¥: {reason}, "
            f"æ—¶é—´: {datetime.now()}"
        )
```

### 9.4 åº”æ€¥å“åº”

å¦‚æœå¯†é’¥æ³„éœ²ï¼Œåº”æ€¥å¤„ç†ï¼š

1. **ç«‹å³é€šçŸ¥ç”¨æˆ·**
2. **å¼ºåˆ¶å¯†é’¥è½®æ¢**
3. **æ’¤é”€æ—§ç‰ˆæœ¬åŒ…**
4. **æ¨é€æ–°çš„åŠ å¯†åŒ…**

---

## é™„å½•

### A. åŠ å¯†ç®—æ³•é€‰æ‹©ç†ç”±

| ç®—æ³• | é€‰æ‹©ç†ç”± |
|------|----------|
| **AES-256-GCM** | è®¤è¯åŠ å¯†ï¼Œé˜²ç¯¡æ”¹ï¼›ç¡¬ä»¶åŠ é€Ÿï¼›æ ‡å‡†æˆç†Ÿ |
| **PBKDF2** | æ ‡å‡†æˆç†Ÿï¼›å¹¿æ³›æ”¯æŒï¼›å¯è°ƒè¿­ä»£æ¬¡æ•° |
| **SHA-256** | æ ‡å‡†å“ˆå¸Œç®—æ³•ï¼›æ— å·²çŸ¥ç¢°æ’ |

### B. ä¾èµ–åº“

```python
# requirements.txt
cryptography>=41.0.0      # åŠ å¯†åº“
PyNaCl>=1.5.0            # é¢å¤–çš„åŠ å¯†å·¥å…·ï¼ˆå¯é€‰ï¼‰
```

### C. å‚è€ƒèµ„æ–™

- [NIST SP 800-38D: GCM Mode](https://csrc.nist.gov/publications/detail/sp/800-38d/final)
- [NIST SP 800-132: PBKDF2](https://csrc.nist.gov/publications/detail/sp/800-132/final)
- [RFC 5652: Cryptographic Message Syntax](https://tools.ietf.org/html/rfc5652)

---

## æ–‡æ¡£å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| v1.0 | 2025-10-01 | Claude | åˆå§‹ç‰ˆæœ¬ |

---

**æ–‡æ¡£ç»“æŸ**
