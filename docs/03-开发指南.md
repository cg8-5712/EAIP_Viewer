# EAIP Viewer 开发指南

## 目录
- [开发环境配置](#开发环境配置)
- [项目结构解析](#项目结构解析)
- [核心模块开发](#核心模块开发)
- [QML 开发指南](#qml-开发指南)
- [数据库设计](#数据库设计)
- [测试规范](#测试规范)
- [代码规范](#代码规范)
- [Git 工作流](#git-工作流)
- [常用开发任务](#常用开发任务)

---

## 开发环境配置

### IDE 推荐

#### VS Code（推荐）
**优点**: 轻量、插件丰富、QML 支持好

**必装插件**:
```
1. Python (Microsoft) - Python 语言支持
2. Pylance - 类型检查和智能提示
3. QML - QML 语法高亮和格式化
4. Qt for Python - PyQt6 代码补全
5. GitLens - Git 增强工具
6. autoDocstring - 自动生成文档字符串
```

**配置文件** `.vscode/settings.json`:
```json
{
  "python.linting.enabled": true,
  "python.linting.pylintEnabled": false,
  "python.linting.flake8Enabled": true,
  "python.formatting.provider": "black",
  "python.formatting.blackArgs": ["--line-length", "100"],
  "editor.formatOnSave": true,
  "editor.rulers": [100],
  "files.exclude": {
    "**/__pycache__": true,
    "**/*.pyc": true,
    "**/.pytest_cache": true
  },
  "python.testing.pytestEnabled": true,
  "python.testing.unittestEnabled": false
}
```

#### PyCharm Professional（备选）
**优点**: 专业 Python IDE、调试功能强大、内置数据库工具

**推荐配置**:
1. 启用 Black 格式化器
2. 配置 Flake8 代码检查
3. 启用类型检查（mypy）
4. 配置 PyQt6 库路径

### 开发工具链

#### 代码质量工具

##### 1. Black（代码格式化）
```bash
# 安装
pip install black

# 格式化单个文件
black src/main.py

# 格式化整个项目
black src/

# 检查但不修改
black --check src/
```

**配置文件** `pyproject.toml`:
```toml
[tool.black]
line-length = 100
target-version = ['py39', 'py310', 'py311']
include = '\.pyi?$'
exclude = '''
/(
    \.git
  | \.venv
  | build
  | dist
)/
'''
```

##### 2. Flake8（代码检查）
```bash
# 安装
pip install flake8

# 检查代码
flake8 src/

# 生成报告
flake8 src/ --output-file=flake8_report.txt
```

**配置文件** `.flake8`:
```ini
[flake8]
max-line-length = 100
exclude = .git,__pycache__,build,dist,.venv
ignore = E203, E266, W503
per-file-ignores =
    __init__.py:F401
```

##### 3. mypy（类型检查）
```bash
# 安装
pip install mypy

# 检查类型
mypy src/

# 生成报告
mypy src/ --html-report mypy_report/
```

**配置文件** `mypy.ini`:
```ini
[mypy]
python_version = 3.11
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = False
exclude = tests/

[mypy-PyQt6.*]
ignore_missing_imports = True

[mypy-fitz.*]
ignore_missing_imports = True
```

#### Git Hooks（自动化检查）

安装 pre-commit:
```bash
pip install pre-commit
```

**配置文件** `.pre-commit-config.yaml`:
```yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.7.0
    hooks:
      - id: black
        language_version: python3.11

  - repo: https://github.com/pycqa/flake8
    rev: 6.1.0
    hooks:
      - id: flake8

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.5.0
    hooks:
      - id: mypy
        additional_dependencies: [types-requests]

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
```

安装 hooks:
```bash
pre-commit install
```

---

## 项目结构解析

### 顶层目录

```
EAIP_Viewer/
├── src/                  # 源代码
├── tests/                # 测试代码
├── docs/                 # 文档
├── resources/            # 资源文件（图标、字体等）
├── data/                 # 运行时数据（数据库、缓存）
├── build_scripts/        # 打包脚本
├── requirements.txt      # 生产依赖
├── requirements-dev.txt  # 开发依赖
├── pyproject.toml        # 项目配置
└── README.md             # 项目说明
```

### src 目录详解

#### 1. main.py - 应用入口
```python
"""
职责:
- 初始化 QApplication
- 加载 QML Engine
- 注册 QML 类型和单例
- 设置应用图标、名称
- 启动主窗口
"""

from PyQt6.QtWidgets import QApplication
from PyQt6.QtQml import QQmlApplicationEngine
import sys

def main():
    app = QApplication(sys.argv)
    app.setApplicationName("EAIP Viewer")

    engine = QQmlApplicationEngine()

    # 注册 QML 类型
    from controllers.auth_controller import AuthController
    qmlRegisterType(AuthController, "EAIP", 1, 0, "AuthController")

    # 加载主 QML 文件
    engine.load("src/qml/main.qml")

    if not engine.rootObjects():
        return -1

    return app.exec()

if __name__ == "__main__":
    sys.exit(main())
```

#### 2. qml/ - QML 界面文件
```
qml/
├── main.qml                  # 主窗口（导航框架）
├── pages/                    # 页面组件
│   ├── LoginPage.qml         # 登录/注册页
│   ├── AirportListPage.qml   # 机场列表页
│   ├── ChartGridPage.qml     # 航图分类网格
│   ├── SearchPage.qml        # 搜索页面
│   └── SettingsPage.qml      # 设置页面
├── components/               # 可复用组件
│   ├── AirportCard.qml       # 机场卡片
│   ├── ChartTypeButton.qml   # 航图类型按钮
│   ├── SearchBar.qml         # 搜索栏
│   └── LoadingIndicator.qml  # 加载动画
└── styles/                   # 样式主题
    ├── Theme.qml             # 主题配置（单例）
    └── Colors.qml            # 色彩定义
```

**QML 文件示例** `main.qml`:
```qml
import QtQuick 2.15
import QtQuick.Controls 2.15
import QtQuick.Window 2.15
import EAIP 1.0

ApplicationWindow {
    id: root
    width: 1280
    height: 720
    visible: true
    title: "EAIP Viewer"

    // 认证控制器
    AuthController {
        id: authController
    }

    // 页面栈
    StackView {
        id: stackView
        anchors.fill: parent
        initialItem: authController.isAuthenticated ? "pages/AirportListPage.qml" : "pages/LoginPage.qml"
    }
}
```

#### 3. controllers/ - QML 控制器（桥接层）
```
controllers/
├── auth_controller.py        # 用户认证控制器
├── airport_model.py          # 机场列表模型
├── chart_provider.py         # 航图图片提供器
└── update_controller.py      # OTA 更新控制器
```

**控制器示例** `auth_controller.py`:
```python
from PyQt6.QtCore import QObject, pyqtSignal, pyqtSlot, pyqtProperty
from core.auth import AuthService

class AuthController(QObject):
    """用户认证控制器 - 暴露给 QML 调用"""

    # 信号
    loginSucceeded = pyqtSignal(str)  # 参数: 用户名
    loginFailed = pyqtSignal(str)     # 参数: 错误信息

    def __init__(self, parent=None):
        super().__init__(parent)
        self._auth_service = AuthService()
        self._username = ""

    @pyqtSlot(str, str)
    def login(self, username: str, password: str):
        """QML 调用的登录方法"""
        success, message = self._auth_service.login(username, password)
        if success:
            self._username = username
            self.loginSucceeded.emit(username)
        else:
            self.loginFailed.emit(message)

    @pyqtProperty(str, notify=loginSucceeded)
    def username(self):
        """当前用户名属性（QML 中可读取）"""
        return self._username
```

#### 4. core/ - 核心业务逻辑
```
core/
├── auth.py               # 用户认证逻辑（纯 Python）
├── database.py           # 数据库操作
├── encryption.py         # 文件加密/解密
├── updater.py            # OTA 更新引擎
├── search_engine.py      # 全文搜索引擎
└── pdf_renderer.py       # PDF 渲染器
```

**核心逻辑示例** `auth.py`:
```python
from typing import Tuple
from models.user import User
from utils.crypto_helper import hash_password, verify_password
from core.database import DatabaseSession

class AuthService:
    """用户认证服务（纯业务逻辑，不依赖 Qt）"""

    def login(self, username: str, password: str) -> Tuple[bool, str]:
        """
        用户登录

        Returns:
            (success, message): (True, "登录成功") 或 (False, "用户名或密码错误")
        """
        with DatabaseSession() as session:
            user = session.query(User).filter_by(username=username).first()

            if not user:
                return False, "用户名或密码错误"

            if not verify_password(password, user.password_hash):
                return False, "用户名或密码错误"

            # 更新最后登录时间
            user.update_last_login()
            session.commit()

            return True, "登录成功"

    def register(self, username: str, email: str, password: str) -> Tuple[bool, str]:
        """用户注册"""
        # 验证逻辑...
        pass
```

#### 5. models/ - 数据模型（SQLAlchemy）
```
models/
├── user.py               # 用户模型
├── airport.py            # 机场模型
├── chart.py              # 航图模型
└── update_cycle.py       # AIRAC Cycle 模型
```

**模型示例** `user.py`:
```python
from sqlalchemy import Column, Integer, String, DateTime, Boolean
from sqlalchemy.ext.declarative import declarative_base
from datetime import datetime

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    username = Column(String(50), unique=True, nullable=False)
    email = Column(String(100), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    last_login_at = Column(DateTime, nullable=True)
    is_active = Column(Boolean, default=True)

    def update_last_login(self):
        self.last_login_at = datetime.utcnow()

    def __repr__(self):
        return f"<User(username='{self.username}', email='{self.email}')>"
```

#### 6. ui/ - Python Widgets（复杂 UI）
```
ui/
├── chart_viewer_widget.py    # 航图查看器（QGraphicsView）
├── annotation_tools.py       # 标注工具栏
└── watermark_overlay.py      # 水印叠加层
```

**Widget 示例** `chart_viewer_widget.py`:
```python
from PyQt6.QtWidgets import QGraphicsView, QGraphicsScene, QGraphicsPixmapItem
from PyQt6.QtGui import QPixmap
from PyQt6.QtCore import Qt

class ChartViewerWidget(QGraphicsView):
    """航图查看器（支持缩放、平移、旋转）"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self.scene = QGraphicsScene(self)
        self.setScene(self.scene)

        self.setRenderHint(QPainter.RenderHint.Antialiasing)
        self.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)
        self.setTransformationAnchor(QGraphicsView.ViewportAnchor.AnchorUnderMouse)

        self.current_scale = 1.0

    def load_chart(self, chart_path: str):
        """加载航图"""
        pixmap = QPixmap(chart_path)
        self.scene.clear()
        self.scene.addPixmap(pixmap)

    def wheelEvent(self, event):
        """鼠标滚轮缩放"""
        factor = 1.25 if event.angleDelta().y() > 0 else 0.8
        self.scale(factor, factor)
        self.current_scale *= factor
```

---

## 核心模块开发

### 1. 用户认证模块

详见后续章节的详细说明。

### 2. PDF 渲染模块

#### 使用 PyMuPDF 渲染 PDF

```python
import fitz  # PyMuPDF
from PyQt6.QtGui import QImage, QPixmap

class PDFRenderer:
    """PDF 渲染器"""

    def __init__(self):
        self.doc = None

    def load_pdf(self, pdf_path: str):
        """加载 PDF 文件"""
        self.doc = fitz.open(pdf_path)

    def render_page(self, page_num: int, dpi: int = 150) -> QPixmap:
        """
        渲染指定页面

        Args:
            page_num: 页码（从 0 开始）
            dpi: 渲染 DPI（越高越清晰但越慢）

        Returns:
            QPixmap: 渲染后的图像
        """
        page = self.doc[page_num]

        # 设置缩放比例（DPI）
        zoom = dpi / 72  # 72 是 PDF 默认 DPI
        mat = fitz.Matrix(zoom, zoom)

        # 渲染为图像
        pix = page.get_pixmap(matrix=mat, alpha=False)

        # 转换为 QImage
        img = QImage(
            pix.samples,
            pix.width,
            pix.height,
            pix.stride,
            QImage.Format.Format_RGB888
        )

        return QPixmap.fromImage(img)

    def close(self):
        """关闭 PDF"""
        if self.doc:
            self.doc.close()
```

### 3. 文件加密模块

#### AES-256 加密实现

```python
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import padding
import os

class FileEncryptor:
    """AES-256 文件加密器"""

    def __init__(self, key: bytes):
        """
        Args:
            key: 32 字节密钥（256 位）
        """
        if len(key) != 32:
            raise ValueError("密钥必须是 32 字节")
        self.key = key

    def encrypt_file(self, input_path: str, output_path: str):
        """加密文件"""
        # 生成随机 IV（初始化向量）
        iv = os.urandom(16)

        # 创建加密器
        cipher = Cipher(
            algorithms.AES(self.key),
            modes.CBC(iv),
            backend=default_backend()
        )
        encryptor = cipher.encryptor()

        # 读取原文件
        with open(input_path, 'rb') as f:
            plaintext = f.read()

        # 填充到 16 字节的倍数
        padder = padding.PKCS7(128).padder()
        padded_data = padder.update(plaintext) + padder.finalize()

        # 加密
        ciphertext = encryptor.update(padded_data) + encryptor.finalize()

        # 写入加密文件（IV + 密文）
        with open(output_path, 'wb') as f:
            f.write(iv + ciphertext)

    def decrypt_file(self, input_path: str, output_path: str):
        """解密文件"""
        # 读取加密文件
        with open(input_path, 'rb') as f:
            data = f.read()

        # 提取 IV 和密文
        iv = data[:16]
        ciphertext = data[16:]

        # 创建解密器
        cipher = Cipher(
            algorithms.AES(self.key),
            modes.CBC(iv),
            backend=default_backend()
        )
        decryptor = cipher.decryptor()

        # 解密
        padded_plaintext = decryptor.update(ciphertext) + decryptor.finalize()

        # 去除填充
        unpadder = padding.PKCS7(128).unpadder()
        plaintext = unpadder.update(padded_plaintext) + unpadder.finalize()

        # 写入解密文件
        with open(output_path, 'wb') as f:
            f.write(plaintext)
```

### 4. 搜索引擎模块

#### 全文搜索实现

```python
from typing import List, Dict
from models.airport import Airport
from models.chart import Chart
from sqlalchemy import or_

class SearchEngine:
    """航图搜索引擎"""

    def __init__(self, session):
        self.session = session

    def search(self, keyword: str) -> Dict[str, List]:
        """
        全局搜索

        Args:
            keyword: 搜索关键词

        Returns:
            {
                'airports': [Airport, ...],
                'charts': [Chart, ...]
            }
        """
        keyword_pattern = f"%{keyword}%"

        # 搜索机场
        airports = self.session.query(Airport).filter(
            or_(
                Airport.icao.ilike(keyword_pattern),
                Airport.name_cn.ilike(keyword_pattern),
                Airport.name_en.ilike(keyword_pattern),
            )
        ).all()

        # 搜索航图
        charts = self.session.query(Chart).filter(
            or_(
                Chart.name.ilike(keyword_pattern),
                Chart.filename.ilike(keyword_pattern),
                Chart.chart_type.ilike(keyword_pattern),
            )
        ).all()

        return {
            'airports': airports,
            'charts': charts
        }

    def search_by_icao_and_type(self, icao: str, chart_type: str) -> List[Chart]:
        """按 ICAO 和类型搜索航图"""
        return self.session.query(Chart).filter(
            Chart.airport_icao == icao,
            Chart.chart_type == chart_type
        ).all()
```

---

## QML 开发指南

### QML 基础语法

#### 属性绑定
```qml
Rectangle {
    width: 200
    height: width * 0.618  // 属性绑定，自动响应 width 变化
    color: "lightblue"
}
```

#### 信号和槽
```qml
Button {
    text: "登录"
    onClicked: {
        // 调用 Python 控制器方法
        authController.login(usernameField.text, passwordField.text)
    }
}

Connections {
    target: authController

    function onLoginSucceeded(username) {
        console.log("登录成功:", username)
        stackView.push("pages/AirportListPage.qml")
    }

    function onLoginFailed(message) {
        errorDialog.text = message
        errorDialog.open()
    }
}
```

### QML 与 Python 交互

#### 1. 从 QML 调用 Python

**Python 端**:
```python
class AuthController(QObject):
    @pyqtSlot(str, str, result=bool)
    def login(self, username: str, password: str) -> bool:
        # 处理登录逻辑
        return True
```

**QML 端**:
```qml
Button {
    text: "登录"
    onClicked: {
        var success = authController.login(username, password)
        if (success) {
            console.log("登录成功")
        }
    }
}
```

#### 2. 从 Python 发送信号到 QML

**Python 端**:
```python
class AuthController(QObject):
    loginSucceeded = pyqtSignal(str)  # 定义信号

    def do_login(self, username, password):
        # ...
        self.loginSucceeded.emit(username)  # 发射信号
```

**QML 端**:
```qml
Connections {
    target: authController
    function onLoginSucceeded(username) {
        console.log("用户登录:", username)
    }
}
```

#### 3. 暴露属性给 QML

**Python 端**:
```python
class AuthController(QObject):
    usernameChanged = pyqtSignal()

    def __init__(self):
        super().__init__()
        self._username = ""

    @pyqtProperty(str, notify=usernameChanged)
    def username(self):
        return self._username

    @username.setter
    def username(self, value):
        if self._username != value:
            self._username = value
            self.usernameChanged.emit()
```

**QML 端**:
```qml
Text {
    text: "当前用户: " + authController.username
    // 自动响应 username 变化
}
```

### QML 列表模型（QAbstractListModel）

**Python 端**:
```python
from PyQt6.QtCore import QAbstractListModel, Qt, QModelIndex

class AirportListModel(QAbstractListModel):
    """机场列表模型"""

    # 定义角色
    IcaoRole = Qt.ItemDataRole.UserRole + 1
    NameCnRole = Qt.ItemDataRole.UserRole + 2
    NameEnRole = Qt.ItemDataRole.UserRole + 3
    ChartCountRole = Qt.ItemDataRole.UserRole + 4

    def __init__(self, airports=None):
        super().__init__()
        self._airports = airports or []

    def rowCount(self, parent=QModelIndex()):
        return len(self._airports)

    def data(self, index, role=Qt.ItemDataRole.DisplayRole):
        if not index.isValid() or index.row() >= len(self._airports):
            return None

        airport = self._airports[index.row()]

        if role == self.IcaoRole:
            return airport.icao
        elif role == self.NameCnRole:
            return airport.name_cn
        elif role == self.NameEnRole:
            return airport.name_en
        elif role == self.ChartCountRole:
            return airport.chart_count

        return None

    def roleNames(self):
        return {
            self.IcaoRole: b"icao",
            self.NameCnRole: b"nameCn",
            self.NameEnRole: b"nameEn",
            self.ChartCountRole: b"chartCount",
        }
```

**QML 端**:
```qml
ListView {
    model: airportListModel  // Python 传递过来的模型

    delegate: Item {
        width: parent.width
        height: 80

        Column {
            Text {
                text: model.icao
                font.bold: true
            }
            Text {
                text: model.nameCn + " / " + model.nameEn
            }
            Text {
                text: model.chartCount + " charts"
                color: "gray"
            }
        }
    }
}
```

---

## 数据库设计

### Schema 设计

```sql
-- 用户表
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login_at DATETIME,
    is_active BOOLEAN DEFAULT 1
);

-- 机场表
CREATE TABLE airports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    icao VARCHAR(4) UNIQUE NOT NULL,
    name_cn VARCHAR(100),
    name_en VARCHAR(100),
    region VARCHAR(50),
    latitude REAL,
    longitude REAL,
    elevation INTEGER
);

-- 航图表
CREATE TABLE charts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    airport_icao VARCHAR(4) NOT NULL,
    chart_type VARCHAR(20) NOT NULL,
    name VARCHAR(100) NOT NULL,
    filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500),
    file_size INTEGER,
    effective_date DATE,
    expiry_date DATE,
    airac_cycle VARCHAR(10),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (airport_icao) REFERENCES airports(icao)
);

-- AIRAC Cycle 表
CREATE TABLE update_cycles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    cycle_number VARCHAR(10) UNIQUE NOT NULL,
    effective_date DATE NOT NULL,
    expiry_date DATE NOT NULL,
    is_installed BOOLEAN DEFAULT 0,
    download_url VARCHAR(500),
    file_size INTEGER,
    installed_at DATETIME
);

-- 收藏表
CREATE TABLE favorites (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    airport_icao VARCHAR(4) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (airport_icao) REFERENCES airports(icao)
);

-- 标注表
CREATE TABLE annotations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    chart_id INTEGER NOT NULL,
    annotation_type VARCHAR(20),  -- pen, text, rectangle, etc.
    annotation_data TEXT,  -- JSON 格式存储坐标和样式
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (chart_id) REFERENCES charts(id)
);
```

### 数据库迁移（Alembic）

#### 初始化 Alembic
```bash
alembic init alembic
```

#### 创建迁移脚本
```bash
alembic revision --autogenerate -m "Initial schema"
```

#### 执行迁移
```bash
# 升级到最新版本
alembic upgrade head

# 回退一个版本
alembic downgrade -1
```

---

## 测试规范

### 单元测试（pytest）

#### 测试文件命名
- 文件名: `test_<module_name>.py`
- 测试函数: `test_<function_name>()`

#### 示例测试

**测试文件** `tests/test_auth.py`:
```python
import pytest
from core.auth import AuthService
from models.user import User

class TestAuthService:
    """用户认证服务测试"""

    @pytest.fixture
    def auth_service(self):
        """测试fixture"""
        return AuthService()

    def test_login_success(self, auth_service):
        """测试登录成功"""
        success, message = auth_service.login("testuser", "password123")
        assert success is True
        assert message == "登录成功"

    def test_login_wrong_password(self, auth_service):
        """测试密码错误"""
        success, message = auth_service.login("testuser", "wrongpassword")
        assert success is False
        assert "密码错误" in message

    def test_register_duplicate_username(self, auth_service):
        """测试重复用户名"""
        # 先注册一次
        auth_service.register("testuser", "test@example.com", "password123")

        # 再次注册相同用户名
        success, message = auth_service.register("testuser", "another@example.com", "password456")
        assert success is False
        assert "用户名已存在" in message
```

#### 运行测试
```bash
# 运行所有测试
pytest

# 运行特定文件
pytest tests/test_auth.py

# 显示详细输出
pytest -v

# 显示打印语句
pytest -s

# 只运行失败的测试
pytest --lf

# 生成覆盖率报告
pytest --cov=src --cov-report=html
```

### 集成测试

**测试 QML 与 Python 集成**:
```python
import pytest
from PyQt6.QtQml import QQmlApplicationEngine
from PyQt6.QtWidgets import QApplication

@pytest.fixture(scope="module")
def qapp():
    """创建 QApplication"""
    app = QApplication([])
    yield app
    app.quit()

def test_qml_loading(qapp):
    """测试 QML 加载"""
    engine = QQmlApplicationEngine()
    engine.load("src/qml/main.qml")

    assert len(engine.rootObjects()) > 0

def test_auth_controller_in_qml(qapp):
    """测试 QML 中的认证控制器"""
    from controllers.auth_controller import AuthController
    from PyQt6.QtQml import qmlRegisterType

    qmlRegisterType(AuthController, "EAIP", 1, 0, "AuthController")

    engine = QQmlApplicationEngine()
    engine.load("src/qml/pages/LoginPage.qml")

    root = engine.rootObjects()[0]
    assert root is not None
```

---

## 代码规范

### Python 编码规范（PEP 8）

#### 命名约定
```python
# 模块名: 小写下划线
import chart_viewer

# 类名: 大驼峰
class AirportListModel:
    pass

# 函数/变量名: 小写下划线
def load_chart(chart_id):
    airport_name = "ZBAA"

# 常量: 大写下划线
MAX_CACHE_SIZE = 1024
DEFAULT_DPI = 150

# 私有成员: 单下划线前缀
class MyClass:
    def __init__(self):
        self._internal_state = 0
```

#### 文档字符串
```python
def encrypt_file(input_path: str, output_path: str, key: bytes) -> bool:
    """
    加密文件

    Args:
        input_path: 输入文件路径
        output_path: 输出文件路径
        key: 32 字节 AES 密钥

    Returns:
        bool: 加密成功返回 True，否则 False

    Raises:
        ValueError: 密钥长度不是 32 字节时抛出
        FileNotFoundError: 输入文件不存在时抛出

    Example:
        >>> key = os.urandom(32)
        >>> encrypt_file("chart.pdf", "chart.enc", key)
        True
    """
    pass
```

### QML 编码规范

#### 命名约定
```qml
// 文件名: 大驼峰
// LoginPage.qml, AirportCard.qml

// 组件 ID: 小驼峰
Item {
    id: loginButton

    // 属性: 小驼峰
    property string userName: ""
    property int chartCount: 0

    // 信号: on<SignalName>
    signal loginClicked(string username)

    onLoginClicked: {
        console.log("Login:", username)
    }
}
```

#### 代码组织
```qml
Rectangle {
    // 1. 基本属性
    width: 200
    height: 100

    // 2. 自定义属性
    property string title: "Title"
    property int value: 0

    // 3. 信号
    signal clicked()

    // 4. 子组件
    Text {
        anchors.centerIn: parent
        text: title
    }

    // 5. 信号处理
    MouseArea {
        anchors.fill: parent
        onClicked: parent.clicked()
    }
}
```

---

## Git 工作流

### 分支策略

```
main          [生产环境分支，只接受合并]
  |
  ├── develop [开发分支]
  |     |
  |     ├── feature/user-auth     [功能分支]
  |     ├── feature/chart-viewer
  |     └── feature/ota-update
  |
  └── hotfix/fix-login-bug  [紧急修复分支]
```

### 提交规范（Conventional Commits）

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）**:
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档变更
- `style`: 代码格式（不影响功能）
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具变更

**示例**:
```bash
git commit -m "feat(auth): add user registration

- Implement user registration form
- Add email validation
- Add password strength check

Closes #123"
```

---

## 常用开发任务

### 添加新的航图类型

1. 修改 `config.py` 添加类型定义
2. 更新数据库 Schema
3. 添加 QML 图标资源
4. 更新搜索引擎逻辑

### 添加新的 QML 页面

1. 在 `src/qml/pages/` 创建 `NewPage.qml`
2. 在 `main.qml` 中注册路由
3. 添加页面控制器（如需要）
4. 编写页面测试

---

下一章节将详细说明**用户认证模块**的完整实现。